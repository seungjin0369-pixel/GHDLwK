<script>
  const dolphin = document.getElementById("dolphin");
  const message = document.getElementById("message");
  const jumpSound = document.getElementById("jumpSound");
  const bgm = document.getElementById("bgm");
  const platforms = document.querySelectorAll(".platform");

  let x = 100;
  let y = 120; // 바닥 기준 돌고래 위치 (bottom)
  let vy = 0;
  let gravity = -1.5;
  let jumping = false;
  const dolphinWidth = 120;
  const dolphinHeight = 80;

  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight") x += 15;
    if (e.key === "ArrowLeft") x -= 15;
    if (e.key === "ArrowUp" && !jumping) {
      jumping = true;
      vy = 20;
      jumpSound.currentTime = 0;
      jumpSound.play();
    }
    if (e.key === " ") sayHoiJja();
  });

  function sayHoiJja() {
    message.style.display = "block";
    message.style.animation = "none";
    void message.offsetWidth;
    message.style.animation = "pop 0.5s ease";

    dolphin.style.transform = "scale(1.2)";
    setTimeout(() => {
      message.style.display = "none";
      dolphin.style.transform = "scale(1)";
    }, 500);
  }

  function update() {
    vy += gravity;
    y += vy;

    // 바닥 충돌
    if (y < 120) { // 바닥 높이
      y = 120;
      vy = 0;
      jumping = false;
    }

    // 발판 충돌 판정
    platforms.forEach(p => {
      const px = p.offsetLeft;
      const py = p.offsetTop;
      const pw = p.offsetWidth;
      const ph = p.offsetHeight;

      // 돌고래 바닥(bottom) 위치
      const dolphinBottom = y;

      if (
        x + dolphinWidth > px &&
        x < px + pw &&
        dolphinBottom >= py + ph && // 돌고래 발이 발판 위에 닿았는지
        dolphinBottom + vy < py + ph && // 내려올 때만
        vy < 0
      ) {
        y = py + ph; // 발판 위로 위치 조정
        vy = 0;
        jumping = false;
      }
    });

    // 화면 밖 이동 방지
    if (x < 0) x = 0;
    if (x > window.innerWidth - dolphinWidth) x = window.innerWidth - dolphinWidth;

    dolphin.style.left = x + "px";
    dolphin.style.bottom = y + "px";

    requestAnimationFrame(update);
  }

  update();

  document.body.addEventListener("click", () => {
    bgm.play();
  }, { once: true });
</script>
